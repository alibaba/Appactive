version: "3"
services:
  # 单机跑demo , 要调大docker内存，否则nacos会闪退
  nacos:
    container_name: nacos
    hostname: nacos
    image: nacos/nacos-server:2.0.3
    environment:
      - PREFER_HOST_MODE=hostname
      - MODE=standalone
    ports:
      - "8848:8848"
      - "9848:9848"
      - "9849:9849"

  mysql:
    container_name: mysql
    hostname: mysql
    image: mysql:5.7
    environment:
      MYSQL_ROOT_PASSWORD: demo_appactiive_pw
      MYSQL_DATABASE: product
    ports:
      - "3306:3306"
    command: [
      --character-set-server=utf8mb4,
      --collation-server=utf8mb4_unicode_ci
    ]

  gateway:
    container_name: gateway
    hostname: gateway
    image: appactiveio/gateway:0.3
    ports:
      - "80:80"
      - "8090:8090"

  storage:
    restart: on-failure:3
    image: appactiveio/storage:0.3
    container_name: storage
    hostname: storage
    environment:
      - dubbo.registry.address=nacos://nacos:8848
      - spring.cloud.nacos.discovery.server-addr=nacos:8848
      - spring.datasource.url=jdbc:mysql://mysql:3306/product?characterEncoding=utf8&useSSL=false&serverTimezone=GMT
#      - spring.datasource.url=jdbc:mysql://mysql:3306/product?characterEncoding=utf8&useSSL=false&serverTimezone=GMT&activeInstanceId=mysql&activeDbName=product
      - appactive.unit=center
      - appactive.app=storage
      - appactive.namespaceId=${appactiveNamespaceId}
      - appactive.configServerAddress=nacos:8848
      - server.port=8881
      - dubbo.protocol.port=-1
      - appactive.channelTypeEnum=NACOS
    volumes:
      - ./data/path-address:/home/admin/appactive/path-address
      - ./data/storage-center:/app/data
    ports:
      - "8881:8881"
    depends_on:
      - "nacos"
      - "mysql"

  storage-unit:
    restart: on-failure:3
    image: appactiveio/storage:0.3
    container_name: storage-unit
    hostname: storage-unit
    environment:
      - dubbo.registry.address=nacos://nacos:8848
      - spring.cloud.nacos.discovery.server-addr=nacos:8848
      - spring.datasource.url=jdbc:mysql://mysql:3306/product?characterEncoding=utf8&useSSL=false&serverTimezone=GMT
#      - spring.datasource.url=jdbc:mysql://mysql:3306/product?characterEncoding=utf8&useSSL=false&serverTimezone=GMT&activeInstanceId=mysql&activeDbName=product
      - appactive.unit=unit
      - appactive.app=storage
      - appactive.namespaceId=${appactiveNamespaceId}
      - appactive.configServerAddress=nacos:8848
      - server.port=8882
      - dubbo.protocol.port=-1
      - appactive.channelTypeEnum=NACOS
    volumes:
      - ./data/path-address:/home/admin/appactive/path-address
      - ./data/storage-unit:/app/data
    ports:
      - "8882:8882"
    depends_on:
      - "nacos"
      - "mysql"

  product:
    restart: on-failure:3
    image: appactiveio/product:0.3
    container_name: product
    hostname: product
    environment:
      - dubbo.registry.address=nacos://nacos:8848
      - spring.cloud.nacos.discovery.server-addr=nacos:8848
      - spring.datasource.url=jdbc:mysql://mysql:3306/product?characterEncoding=utf8&useSSL=false&serverTimezone=GMT
      - appactive.unit=center
      - appactive.app=product
      - appactive.namespaceId=${appactiveNamespaceId}
      - appactive.configServerAddress=nacos:8848
      - server.port=8883
      - dubbo.protocol.port=-1
      - appactive.channelTypeEnum=NACOS
    volumes:
      - ./data/path-address:/home/admin/appactive/path-address
      - ./data/product-center:/app/data
    ports:
      - "8883:8883"
    depends_on:
      - "nacos"
      - "mysql"
      - "storage"

  product-unit:
    restart: on-failure:3
    image: appactiveio/product:0.3
    container_name: product-unit
    hostname: product-unit
    environment:
      - dubbo.registry.address=nacos://nacos:8848
      - spring.cloud.nacos.discovery.server-addr=nacos:8848
      - spring.datasource.url=jdbc:mysql://mysql:3306/product?characterEncoding=utf8&useSSL=false&serverTimezone=GMT
      - appactive.unit=unit
      - appactive.app=product
      - appactive.namespaceId=${appactiveNamespaceId}
      - appactive.configServerAddress=nacos:8848
      - server.port=8884
      - dubbo.protocol.port=-1
      - appactive.channelTypeEnum=NACOS
    volumes:
      - ./data/path-address:/home/admin/appactive/path-address
      - ./data/product-unit:/app/data
    ports:
      - "8884:8884"
    depends_on:
      - "nacos"
      - "mysql"
      - "storage-unit"

  frontend:
    restart: on-failure:3
    image: appactiveio/frontend:0.3
    container_name: frontend
    hostname: frontend
    environment:
      - dubbo.registry.address=nacos://nacos:8848
      - spring.cloud.nacos.discovery.server-addr=nacos:8848
      - appactive.unit=center
      - appactive.app=frontend
      - appactive.namespaceId=${appactiveNamespaceId}
      - appactive.configServerAddress=nacos:8848
      - io.appactive.demo.unitlist=center,unit
      - io.appactive.demo.applist=frontend,product,storage
      - server.port=8885
      - appactive.channelTypeEnum=NACOS
    volumes:
      - ./data/path-address:/home/admin/appactive/path-address
      - ./data/frontend-center:/app/data
    ports:
      - "8885:8885"
    depends_on:
      - "nacos"
      - "product"

  frontend-unit:
    restart: on-failure:3
    image: appactiveio/frontend:0.3
    container_name: frontend-unit
    hostname: frontend-unit
    environment:
      - dubbo.registry.address=nacos://nacos:8848
      - spring.cloud.nacos.discovery.server-addr=nacos:8848
      - appactive.unit=unit
      - appactive.app=frontend
      - appactive.namespaceId=${appactiveNamespaceId}
      - appactive.configServerAddress=nacos:8848
      - io.appactive.demo.unitlist=center,unit
      - io.appactive.demo.applist=frontend,product,storage
      - server.port=8886
      - appactive.channelTypeEnum=NACOS
    volumes:
      - ./data/path-address:/home/admin/appactive/path-address
      - ./data/frontend-unit:/app/data
    ports:
      - "8886:8886"
    depends_on:
      - "nacos"
      - "product-unit"
